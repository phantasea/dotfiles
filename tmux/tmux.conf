unbind-key C-b
unbind-key escape
set-option -g prefix `
bind "'" send-prefix

set -g  default-terminal   "screen-256color"
set -ga terminal-overrides ",st-256color"

#set -g allow-passthrough on
#set -ga update-environment TERM
#set -ga update-environment TERM_PROGRAM

### general setting {{{
# disable <ESC> working as meta-key
set -g  escape-time        0
set -g  allow-rename       off
set -g  base-index         1
set -g  display-time       1500
set -g  mode-keys          vi
set -pg pane-active-border-style     "fg=red   bg=black"
set -pg pane-border-style            "fg=white bg=black"
set -wg mode-style                   "fg=black bg=magenta"

set -g  pane-border-lines  single
set -g  popup-border-lines rounded

setw -g clock-mode-colour  cyan
setw -g clock-mode-style   24
setw -g pane-base-index    1

set -g lock-command vlock
if "x-is-run" \
"set -g lock-after-time 0" \
"set -g lock-after-time 1500"
### }}}

#%if #{>=:#{version},3.0}
#set xxx xxx
#%else
#set yyy yyy
#%endif

### bind-key general part-2 {{{
bind -n 'C-M-L' lock-session

bind '~'    run-shell -b "if ! x-is-run; then fbgrab ~/misc/snapshot-$(date +%Y%m%d%H%M%S).png; \
                         else scrot $HOME/misc/scrot_`date +%Y%m%d_%H%M%S`.jpg; fi"
bind >      run-shell -b "~/.util/autocd"
bind .      run-shell -b "~/.util/autocd -b"
bind `      selectw -l
bind /      selectw -t:fzfmux
bind m      if-shell "tmux selectw -t:music" "" \
                     'if-shell "tmux selectw -t:vidplay" "" "run-shell -b \"musmux -b\""'

bind tab    if-shell "x-is-run" "set status\; set status-position bottom" \
                                "set status\; set status-position top"
bind btab   if-shell "x-is-run" "set status\; set status-position top" \
                                "set status\; set status-position bottom"
bind enter  selectw -t:1
bind space  if-shell "tmux selectw -t:9" "" 'run-shell -b fmopen'
bind bspace if-shell "tmux selectw -t:0" "" 'run-shell -b "fmopen -b"'

bind -n 'DC'       new-window\; send-keys 'tty-clock -cB -C 6 && tmux kill-window'  'Enter'
bind -n 'IC'       new-window\; send-keys 'cmatrix -ab -C cyan && tmux kill-window' 'Enter'
bind -n 'F12'      new-window\; send-keys 'cmatrix -ab -C cyan && tmux kill-window' 'Enter'

#cycle thru panes/windows
bind -n 'M-n'      select-pane -t:.+1
bind -n 'M-p'      select-pane -t:.-1
bind -n 'M-tab'    select-window -n
bind -n 'M-enter'  selectw -T -t:bash
bind -n 'M-m'      selectw -t:vidplay
### }}}

bind -n 'M-u'      run 'scratchpad -T'
bind -n 'M-y'      run 'scratchpad -Y'
bind -n 'M-escape' run 'scratchpad -X'
bind -n 'M-DC'     run 'scratchpad -X'
bind -n 'M-bspace' run 'scratchpad -X'
bind -n 'M-`'      run 'scratchpad -PB asmr "mocp /opt/.porn/asmr" 64% 64%'
bind -n 'M-space'  run 'scratchpad -P  nova "ranger /opt/.porn/text /opt/.porn/vids" 81% 64%'

### For tmux-3.0a(/opt/misc/appimg/tmux.appimage) {{{
#if "x-is-run" \
#   'set -g  default-terminal   "screen-256color"; \
#    set -ga terminal-overrides ",st-256color"'
#
#asmr_cmd='mocp /opt/.porn/asmr'
#asmr_m3u_file='/opt/.porn/asmr/asmr.m3u'
#mocp_m3u='test -f $asmr_m3u_file && mocp -a $asmr_m3u_file'
#new_win_asmr='new-window -n asmr -t 13:13 $asmr_cmd; run-shell -b $mocp_m3u'
#bind -n 'M-`' \
#     if 'tmux list-s | egrep "13:.*attached" 2>/dev/null' \
#        "if 'tmux list-w | grep asmr | grep active' 'switch-c -t 0' 'select-w -t:asmr'" \
#        "if 'tmux switch-c -t 13:asmr 2>/dev/null' '' '$new_win_asmr; switch-c -t 13:asmr'"
#
#nova_cmd='ranger /opt/.porn/text /opt/.porn/vids'
#new_win_nova='new-window -n nova -t 13:11 $nova_cmd'
#bind -n 'M-space' \
#     if 'tmux list-s | egrep "13:.*attached" 2>/dev/null' \
#        "if 'tmux list-w | grep nova | grep active' 'switch-c -t 0' 'select-w -t:nova'" \
#        "if 'tmux switch-c -t 13:nova 2>/dev/null' '' '$new_win_nova; switch-c -t 13:nova'"
#
#bind -n 'DC'       move-window -s 0 -t 13:15
#bind -n 'M-escape' move-window -s 0 -t 13:15
#bind -n 'M-u' \
#     if 'tmux list-s | egrep "13:.*attached" 2>/dev/null' \
#        "if 'tmux list-w | grep 15: | grep active' 'switch-c -t 0' 'select-w -t:15'" \
#        "switch-c -t 13:15"
#
#bind -n 'M-y' \
#     if 'tmux list-s | egrep "13:.*attached" 2>/dev/null' \
#        "select-w -t:+1" "switch-c -t 13"
#
#bind -n 'BTab' \
#     if 'tmux list-s | egrep "13:.*attached" 2>/dev/null' \
#        "select-w -t:+1" "switch-c -t 13"
#
##bind -n 'M-u'  if 'tmux list-s | egrep "13:.*attached" 2>/dev/null' \
##                  'switch-c -t 0' 'switch-c -t 13:bash'
##
##bind -n 'M-y'  if 'tmux list-w | egrep "asmr\*"' 'move-w -s 0:13 -t 13:13' \
##                  "if 'tmux select-w -t:asmr 2>/dev/null' '' 'move-w -s 13:13 -t 0:13'"
### }}}

### bind-key for mocp/fzf {{{
bind -n 'M-;'      run-shell -b "mocp --next"
bind -n 'M-,'      run-shell -b "mocp --previous"
bind -n 'M-.'      run-shell -b "mocp --toggle-pause"
bind -n 'M-['      run-shell -b "mocp --seek -10"
bind -n 'M-]'      run-shell -b "mocp --seek +10"
bind -n 'M-Left'   run-shell -b "mocp --seek -20"
bind -n 'M-Right'  run-shell -b "mocp --seek +20"
bind -n 'M-1'      run-shell -b "mocp --jump 10% >/dev/null"
bind -n 'M-2'      run-shell -b "mocp --jump 20% >/dev/null"
bind -n 'M-3'      run-shell -b "mocp --jump 30% >/dev/null"
bind -n 'M-4'      run-shell -b "mocp --jump 40% >/dev/null"
bind -n 'M-5'      run-shell -b "mocp --jump 50% >/dev/null"
bind -n 'M-6'      run-shell -b "mocp --jump 60% >/dev/null"
bind -n 'M-7'      run-shell -b "mocp --jump 70% >/dev/null"
bind -n 'M-8'      run-shell -b "mocp --jump 80% >/dev/null"
bind -n 'M-9'      run-shell -b "mocp --jump 90% >/dev/null"
bind -n 'M-0'      run-shell -b "mocp --jump 00% >/dev/null"
bind -n 'M-<'      run-shell -b "mocp --volume -7"
bind -n 'M->'      run-shell -b "mocp --volume +7"

bind F run-shell -b 'fzfmux fff'
bind A run-shell -b 'fzfmux ffa'
bind V run-shell -b 'fzfmux ffv'
bind W run-shell -b 'fzfmux ffw'
bind X run-shell -b 'fzfmux ffx'
### }}}

### bind-key general part-2 {{{
bind r source-file ~/.tmux.conf \; display-message "Config reloaded..."

bind R refresh-client

bind t clock-mode

bind w choose-window

bind s split-window -v
bind v split-window -h

bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

bind -r H resize-pane -L 1
bind -r L resize-pane -R 1
bind -r J resize-pane -D 2
bind -r K resize-pane -U 2

bind u popup -E -w64% -h64% "tmux list-buffers | cut -d: -f3 | fzf | xargs tmux set-buffer"

bind U capture-pane -J \; save-buffer "/tmp/tmux-buffer" \; \
       delete-buffer \; split-window -l 10 "urlview '/tmp/tmux-buffer'"
### }}}

### bind-key for copy-mode {{{
bind i copy-mode

if-shell "x-is-run" \
         'bind o run -b "tmux set-buffer \"$(xclip -o -sel clip)\"; tmux paste-buffer"' \
         'bind o paste-buffer'
bind O paste-buffer

if-shell "x-is-run" \
         'bind y copy-mode \; send-keys vey \; run -b "tmux show-buffer | xclip -i -sel clip"' \
         'bind y copy-mode \; send-keys vey'

bind Y  copy-mode \; send -l ^v \; send -X end-of-line \; send hy
#bind Y run -b 'tmux save-buffer - | xclip -i -sel clip'
#bind Y run -b 'tmux show-buffer | xclip -i -sel clip'

bind -T copy-mode-vi 'v' send -X begin-selection
if-shell "x-is-run" \
         "bind -T copy-mode-vi 'y' send -X copy-pipe-and-cancel \"xclip -i -sel clip\"" \
         "bind -T copy-mode-vi 'y' send -X copy-selection-and-cancel"

bind -T copy-mode-vi 'C-v' send -X rectangle-toggle
bind -T copy-mode-vi 'C-j' send -X page-down
bind -T copy-mode-vi 'C-k' send -X page-up
bind -T copy-mode-vi 'H'   send -X top-line
bind -T copy-mode-vi 'M'   send -X middle-line
bind -T copy-mode-vi 'L'   send -X bottom-line
bind -T copy-mode-vi 'J'   send -X scroll-down
bind -T copy-mode-vi 'K'   send -X scroll-up
### }}}

### bind-key for misc part {{{
# Smart pane switching with awareness of Vim splits.
# See: https://github.com/christoomey/vim-tmux-navigator
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
#bind -n C-h if-shell "$is_vim" "send-keys C-h"  "select-pane -L"
#bind -n C-j if-shell "$is_vim" "send-keys C-j"  "select-pane -D"
#bind -n C-k if-shell "$is_vim" "send-keys C-k"  "select-pane -U"
#bind -n C-l if-shell "$is_vim" "send-keys C-l"  "select-pane -R"
#bind -n C-\ if-shell "$is_vim" "send-keys C-\\" "select-pane -l"

# Hide and show window name from status line
#bind '-' setw window-status-format '#I'\; setw window-status-current-format '#I'
#bind '+' setw window-status-format '#I:#W#F'\; setw window-status-current-format '#I:#W#F'
### }}}

### tmux menu {{{
bind-key -n F1 display-menu -x W -y S \
    "New Session"                        S "command-prompt -p \"New Session:\" \"new-session -A -s '%%'\"" \
    "Kill Session"                       x "kill-session" \
    "Kill Other Session(s)"              X "kill-session -a" \
    "" \
    "New Window"                         ␍ "new-window" \
    "Kill Window"                        k "killw" \
    "Choose Window"                      w "choose-window" \
    "Previous Window"                    p "previous-window" \
    "Next Window"                        n "next-window" \
    "Swap Window Right"                  R "swap-window -t -1" \
    "Swap Window Left"                   L "swap-window -t +1" \
    "Horizontal Split"                   v "split-window -h" \
    "Vertical Split"                     s "split-window -v" \
    "" \
    "Layout Horizontal"                  h "select-layout even-horizontal" \
    "Layout Vertical"                    k "select-layout even-horizontal" \
    "" \
    "Swap Pane Up"                       < "swap-pane -U" \
    "Swap Pane Down"                     > "swap-pane -D" \
    "Break Pane"                         t "break-pane" \
    "Join Pane"                          j "choose-window 'join-pane -h -s \"%%\"'" \
    "#{?window_zoomed_flag,Unzoom,Zoom}" z "resize-pane -Z"
### }}}

### status line config {{{
set -g  status              off
set -g  status-keys         emacs
set -g  status-position     top
set -g  status-interval     8
set -g  status-justify      centre
set -g  status-right-length 64
set -g  status-style        "fg=black bg=white"
set -g  status-left-style   "fg=white bg=red"
set -g  status-right-style  "fg=white bg=red"
set -wg window-status-style         "fg=black bg=cyan"
set -wg window-status-last-style    "fg=black bg=yellow"
set -wg window-status-current-style "fg=black bg=green bold blink"
#set -g status-right '-#(date -d "today" +"%b %d, %a") | #(date -d "today" +"%H:%M")-'
#CPU_CMD='iostat -c 1 2 | sed "/^\s*$/d" | tail -n 1 | grep -o "[^ ]*$"'
#CPU_CMD='iostat -c 1 2 | sed "/^\s*$/d" | tail -n 1 | awk "{print 100-\$NF}" | cut -d. -f1'
#MEM_CMD='free | awk -v format="%3.1f%%\n" "\$1 ~ /Mem/ {printf(format, 100*\$3/\$2)}"'
NET_CMD='cat /sys/class/net/$(ip route | awk "/^default/ { print \$5; exit }")/operstate | tr "[:lower:]" "[:upper:]"'
BTC_CMD='bluetoothctl info 0C:17:73:D9:EB:09 | grep "Connected" | cut -d":" -f2 | sed -e "s/\s//g" | tr "[:lower:]" "[:upper:]"'
CPU_CMD='iostat -c 1 2 | sed "/^\s*$/d" | tail -n 1 | awk -v format="%3.1f%%\n" "{usage=100-\$NF} END {printf(format, usage)}" | sed "s/,/./"'
TMP_CMD='sensors | grep "Tctl" | cut -d"+" -f2 | sed "s/\s\+$//"'
BAT_CMD='acpi -b | grep -m 1 -Eo "[0-9]+%"'
VOL_CMD='amixer -D pulse sget Master | grep "Left:" | awk -F"[][]" "{ print \$2 }" | cut -d "%" -f1 | sed "s/$/%/"'
color0='bg=white'
color1='bg=magenta fg=black'
color2='bg=red fg=white'
set -g status-left  '-#{session_name}-'
if "x-is-run" '\
set -g status-right "\
#[$color1] #($NET_CMD)#[$color0]|\
#[$color1] #($BTC_CMD)#[$color0]|\
#[$color1] #($CPU_CMD)#[$color0]|\
#[$color1] #($TMP_CMD)#[$color0]|\
#[$color1] #($BAT_CMD)#[$color0]|\
#[$color1] #($VOL_CMD)#[$color0]|\
#[$color2]%H:%M"' '\
set -g status-right "\
#[$color1]NET=#($NET_CMD)#[$color0] \
#[$color1]BTC=#($BTC_CMD)#[$color0] \
#[$color1]CPU=#($CPU_CMD)#[$color0] \
#[$color1]TMP=#($TMP_CMD)#[$color0] \
#[$color1]BAT=#($BAT_CMD)#[$color0] \
#[$color1]VOL=#($VOL_CMD)#[$color0] \
#[$color2]%H:%M"'
##[$color2]%a %h/%d %H:%M"'
### }}}

### tmux plugins {{{
run ~/.tmux/plugins/tmux-open/open.tmux
set -g @open 'o'
set -g @open-editor 'C-o'
set -g @open-S 'https://www.google.com/search?q='
set -g @open-B 'https://www.bing.com/search?q='
### }}}

# vim: set ft=tmux foldmethod=marker:
