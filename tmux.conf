# vim: set ft=tmux :

unbind-key C-b
set-option -g prefix `
bind "'" send-prefix

if-shell "x-is-run" \
'set -g  default-terminal   "screen-256color"; \
 set -ga terminal-overrides ",st-256color"'

# disable <ESC> working as meta-key
set -g  escape-time        0
set -g  allow-rename       off
set -g  base-index         1
set -g  display-time       1000
set -g  mode-keys          vi
set -g  status-keys        emacs
set -g  status-position    top
set -g  status-interval    0
set -g  status             off
set -g  status-justify     centre
set -g  status-left                  '-#(date -d "today" +"%H:%M")-'
set -g  status-right                 '-#(date -d "today" +"%b %d, %a")-'
set -g  status-style                 "fg=black bg=white"
set -g  status-left-style            "fg=white bg=red"
set -g  status-right-style           "fg=white bg=red"
set -pg pane-active-border-style     "fg=red   bg=black"
set -pg pane-border-style            "fg=white bg=black"
set -wg window-status-style          "fg=black bg=yellow"
set -wg window-status-current-style  "fg=black bg=green"
set -wg window-status-last-style     "fg=black bg=cyan"
set -wg mode-style                   "fg=black bg=magenta"

setw -g clock-mode-colour  cyan
setw -g clock-mode-style   24
setw -g pane-base-index    1

bind '~'    run-shell -b "if ! x-is-run; then fbgrab ~/misc/snapshot-$(date +%Y%m%d%H%M%S).png; \
                         else scrot $HOME/misc/scrot_`date +%Y%m%d_%H%M%S`.jpg; fi"
bind >      run-shell -b "~/.util/autocd"
bind .      run-shell -b "~/.util/autocd"
bind `      selectw -l
bind /      selectw -t:fzfmux
bind m      if-shell "tmux selectw -t:music" "" \
                     'if-shell "tmux selectw -t:vidplay" "" "run-shell -b \"musmux -b\""'

bind tab    if-shell "x-is-run" "set-option status\; set status-position bottom" \
                                "set-option status\; set status-position top"
bind enter  selectw -t:bash
bind space  if-shell "tmux selectw -t:9" "" 'run-shell -b fmopen'
bind bspace if-shell "tmux selectw -t:0" "" 'run-shell -b "fmopen -b"'

#cycle thru panes/windows
bind -n 'M-bspace' select-pane -t:.+
bind -n 'M-tab'    select-window -n
bind -n 'M-space'  select-window -l
bind -n 'M-enter'  selectw -T -t:bash
bind -n 'M-`'      if-shell 'tmux list-w | egrep "asmr\*"' 'selectw -l' \
                  'if-shell "tmux selectw -t:asmr" "" "run-shell \"musmux -d\"\; selectw -t:asmr"'

bind -n 'M-Left'   run-shell -b "~/.util/musdo -S"
bind -n 'M-Right'  run-shell -b "~/.util/musdo -s"
bind -n 'M-['      run-shell -b "~/.util/musdo -S"
bind -n 'M-]'      run-shell -b "~/.util/musdo -s"
bind -n 'M-,'      run-shell -b "~/.util/musdo -p"
bind -n 'M-;'      run-shell -b "~/.util/musdo -n"
bind -n 'M-.'      run-shell -b "~/.util/musdo -t"

bind -n F11        new-window\; send-keys 'tty-clock -cB -C 6 && tmux kill-window'  'Enter'
bind -n F12        new-window\; send-keys 'cmatrix -ab -C cyan && tmux kill-window' 'Enter'
bind -n 'IC'       new-window\; send-keys 'cmatrix -ab -C cyan && tmux kill-window' 'Enter'
bind -n 'DC'       selectw -t:1\; send-keys 'C-u' 'vlock' 'Enter'

bind F run-shell -b 'fzfmux fff'
bind A run-shell -b 'fzfmux ffa'
bind V run-shell -b 'fzfmux ffv'
bind W run-shell -b 'fzfmux ffw'
bind X run-shell -b 'fzfmux ffx'

bind r source-file ~/.tmux.conf \; display-message "Config reloaded..."

bind R refresh-client

bind t clock-mode

bind w choose-window

bind s split-window -v
bind v split-window -h

bind h select-pane -L
bind j select-pane -D
bind k select-pane -U
bind l select-pane -R

bind -r H resize-pane -L 1
bind -r L resize-pane -R 1
bind -r J resize-pane -D 2
bind -r K resize-pane -U 2

bind U capture-pane -J \; save-buffer "/tmp/tmux-buffer" \; \
       delete-buffer \; split-window -l 10 "urlview '/tmp/tmux-buffer'"

bind i copy-mode
bind u paste-buffer

if-shell "x-is-run" \
'bind o run -b "tmux set-buffer \"$(xclip -o -sel clip)\"; tmux paste-buffer"' \
'bind o paste-buffer'

if-shell "x-is-run" \
'bind y copy-mode \; send-keys vey \; run -b "tmux show-buffer | xclip -i -sel clip"' \
'bind y copy-mode \; send-keys vey'

#bind Y run -b 'tmux save-buffer - | xclip -i -sel clip'
#bind Y run -b 'tmux show-buffer | xclip -i -sel clip'

bind -T copy-mode-vi 'v'   send -X begin-selection
if-shell "x-is-run" \
"bind -T copy-mode-vi 'y'   send -X copy-pipe-and-cancel \"xclip -i -sel clip\"" \
"bind -T copy-mode-vi 'y'   send -X copy-selection-and-cancel"

bind -T copy-mode-vi 'C-v' send -X rectangle-toggle
bind -T copy-mode-vi 'C-j' send -X page-down
bind -T copy-mode-vi 'C-k' send -X page-up
bind -T copy-mode-vi 'H'   send -X top-line
bind -T copy-mode-vi 'M'   send -X middle-line
bind -T copy-mode-vi 'L'   send -X bottom-line
bind -T copy-mode-vi 'J'   send -X scroll-down
bind -T copy-mode-vi 'K'   send -X scroll-up

# Smart pane switching with awareness of Vim splits.
# See: https://github.com/christoomey/vim-tmux-navigator
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ ]+ +(\\S+\\/)?g?(view|n?vim?x?)(diff)?$'"
#bind -n C-h if-shell "$is_vim" "send-keys C-h"  "select-pane -L"
#bind -n C-j if-shell "$is_vim" "send-keys C-j"  "select-pane -D"
#bind -n C-k if-shell "$is_vim" "send-keys C-k"  "select-pane -U"
#bind -n C-l if-shell "$is_vim" "send-keys C-l"  "select-pane -R"
#bind -n C-\ if-shell "$is_vim" "send-keys C-\\" "select-pane -l"

# Hide and show window name from status line
#bind '-' setw window-status-format '#I'\; setw window-status-current-format '#I'
#bind '+' setw window-status-format '#I:#W#F'\; setw window-status-current-format '#I:#W#F'

bind-key -n F1 display-menu -x W -y S \
    "New Session"                        S "command-prompt -p \"New Session:\" \"new-session -A -s '%%'\"" \
    "Kill Session"                       x "kill-session" \
    "Kill Other Session(s)"              X "kill-session -a" \
    "" \
    "New Window"                         ␍ new-window \
    "Kill Window"                        k "killw"  \
    "Choose Window"                      w choose-window \
    "Previous Window"                    ← previous-window \
    "Next Window"                        → next-window \
    "Swap Window Right"                  ↑ "swap-window -t -1" \
    "Swap Window Left"                   ↓ "swap-window -t +1" \
    "Horizontal Split"                   v "split-window -h" \
    "Vertical Split"                     s "split-window -v"  \
    "" \
    "Layout Horizontal"                  h "select-layout even-horizontal"  \
    "Layout Vertical"                    k "select-layout even-horizontal"  \
    "" \
    "Swap Pane Up"                       < "swap-pane -U" \
    "Swap Pane Down"                     > "swap-pane -D" \
    "Break Pane"                         t break-pane \
    "Join Pane"                          j "choose-window 'join-pane -h -s \"%%\"'" \
    "#{?window_zoomed_flag,Unzoom,Zoom}" z "resize-pane -Z"
